name: ğŸš€ Deploy Terraform to Azure

on:
  workflow_dispatch:
    inputs:
      destroy:
        description: 'ğŸ§¨ DESTRUIR infraestrutura?'
        required: true
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

permissions:
  id-token: write
  contents: read

env:
  ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
  ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
  ARM_USE_CLI: true

jobs:
  validate:
    if: github.event.inputs.destroy == 'false'
    name: ğŸ” Validar Terraform
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v3

      - name: ğŸ” Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ğŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.6.0'

      - name: ğŸ“¦ Terraform Init
        working-directory: infra
        run: terraform init -backend-config="key=prod.terraform.tfstate"

      - name: âœ… Terraform Validate
        working-directory: infra
        run: terraform validate

      - name: ğŸ“‹ Terraform Plan
        working-directory: infra
        run: |
          terraform plan \
            -var="resource_group_name=${{ vars.AZURE_RG }}" \
            -var="location=${{ vars.AZURE_LOCATION }}" \
            -var="admin_password=${{ secrets.ADMIN_PASSWORD }}" \
            -input=false

  deploy:
    if: github.event.inputs.destroy == 'false'
    name: ğŸš€ Deploy e ConfiguraÃ§Ã£o
    needs: validate
    runs-on: ubuntu-latest
    outputs:
      vmName: ${{ steps.output_vm.outputs.vm_name }}
      adminUsername: ${{ steps.output_vm.outputs.admin_username }}
      publicIP: ${{ steps.output_vm.outputs.public_ip }}
      nsgName: ${{ steps.output_vm.outputs.nsg_name }}
      resourceGroup: ${{ steps.output_vm.outputs.resource_group }}
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v3

      - name: ğŸ” Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ğŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.6.0'

      - name: ğŸ“¦ Terraform Init
        working-directory: infra
        run: terraform init -backend-config="key=prod.terraform.tfstate"

      - name: ğŸš€ Terraform Apply
        working-directory: infra
        run: |
          terraform apply \
            -var="resource_group_name=${{ vars.AZURE_RG }}" \
            -var="location=${{ vars.AZURE_LOCATION }}" \
            -var="admin_password=${{ secrets.ADMIN_PASSWORD }}" \
            -auto-approve

      - name: ğŸ“¤ Capturar Outputs
        id: output_vm
        working-directory: infra
        run: |
          echo "vm_name=$(terraform output -raw vm_name)" >> $GITHUB_OUTPUT
          echo "admin_username=$(terraform output -raw admin_username)" >> $GITHUB_OUTPUT
          echo "public_ip=$(terraform output -raw public_ip_address)" >> $GITHUB_OUTPUT
          echo "nsg_name=$(terraform output -raw nsg_name)" >> $GITHUB_OUTPUT
          echo "resource_group=$(terraform output -raw resource_group_name)" >> $GITHUB_OUTPUT

      - name: ğŸ”§ Instalar Ansible e sshpass
        run: |
          sudo apt-get update
          sudo apt-get install -y ansible sshpass

      - name: ğŸ“ Criar InventÃ¡rio Ansible
        run: |
          echo "[vm]" > inventory
          echo "${{ steps.output_vm.outputs.public_ip }} ansible_user=azureuser ansible_password=${{ secrets.ADMIN_PASSWORD }} ansible_ssh_common_args='-o StrictHostKeyChecking=no'" >> inventory

      - name: ğŸ“˜ Executar Playbook Ansible
        run: |
          ansible-playbook -i inventory ansible/playbook.yml \
            --extra-vars "ansible_sudo_pass=${{ secrets.ADMIN_PASSWORD }}"

  post-tests:
    if: github.event.inputs.destroy == 'false'
    name: âœ… PÃ³s-Testes
    needs: deploy
    runs-on: ubuntu-latest
    env:
      PUBLIC_IP: ${{ needs.deploy.outputs.publicIP }}
      VM_NAME: ${{ needs.deploy.outputs.vmName }}
      NSG_NAME: ${{ needs.deploy.outputs.nsgName }}
      RESOURCE_GROUP: ${{ needs.deploy.outputs.resourceGroup }}

    steps:
      - name: ğŸ” Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ğŸ§ª Testar Swagger
        run: |
          sleep 30
          curl -f http://$PUBLIC_IP:8081/swagger-ui/index.html

      - name: âœ… Verificar VM
        run: |
          az vm show --name $VM_NAME --resource-group $RESOURCE_GROUP --query "powerState" -o tsv

  destroy:
    if: github.event.inputs.destroy == 'true'
    name: ğŸ§¨ Destruir Infraestrutura
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v3

      - name: ğŸ” Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ğŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.6.0'

      - name: ğŸ“¦ Terraform Init
        working-directory: infra
        run: terraform init -backend-config="key=prod.terraform.tfstate"

      - name: ğŸ’¥ Terraform Destroy
        working-directory: infra
        run: terraform destroy -auto-approve