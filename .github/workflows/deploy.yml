name: üöÄ Deploy Terraform to Azure (Com Destroy option)

# =====================================================
# TRIGGERS - Simplificado como o professor
# =====================================================
on:
  workflow_dispatch:
    inputs:
      destroy:
        description: 'üß® DESTRUIR infraestrutura?'
        required: true
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

permissions:
  id-token: write
  contents: read

jobs:
  # =========================================
  # JOB 1: VALIDATE - Sem fmt -check!
  # =========================================
  validate:
    if: github.event.inputs.destroy == 'false'
    name: üîé Validar Terraform
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v3

      - name: üîê Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: üîß Instalar Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.6.0'

      - name: üì¶ Terraform Init (Backend remoto!)
        working-directory: infra
        run: |
          export ARM_SUBSCRIPTION_ID=${{ secrets.ARM_SUBSCRIPTION_ID }}
          terraform init \
            -backend-config="resource_group_name=${{ vars.TF_BACKEND_RG }}" \
            -backend-config="storage_account_name=${{ vars.TF_BACKEND_STORAGE }}" \
            -backend-config="container_name=${{ vars.TF_BACKEND_CONTAINER }}" \
            -backend-config="key=prod.terraform.tfstate"

      - name: ‚úÖ Terraform Validate (Sintaxe)
        working-directory: infra
        run: terraform validate

      - name: üìã Terraform Plan (Dry-run)
        working-directory: infra
        run: |
          export ARM_SUBSCRIPTION_ID=${{ secrets.ARM_SUBSCRIPTION_ID }}
          terraform plan \
            -var="resource_group_name=${{ vars.AZURE_RG }}" \
            -var="location=${{ vars.AZURE_LOCATION }}" \
            -var="admin_password=${{ secrets.ADMIN_PASSWORD }}" \
            -input=false

  # =========================================
  # JOB 2: DEPLOY - Deploy e Ansible
  # =========================================
  deploy:
    if: github.event.inputs.destroy == 'false'
    name: üöÄ Deploy e Configura√ß√£o
    needs: validate
    runs-on: ubuntu-latest
    outputs:
      vmName: ${{ steps.output_vm.outputs.vm_name }}
      adminUsername: ${{ steps.output_vm.outputs.admin_username }}
      publicIP: ${{ steps.output_vm.outputs.public_ip }}
      nsgName: ${{ steps.output_vm.outputs.nsg_name }}
      resourceGroup: ${{ steps.output_vm.outputs.resource_group }}

    steps:
      - name: üì• Checkout
        uses: actions/checkout@v3

      - name: üîê Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: üîß Instalar Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.6.0'

      - name: üì¶ Terraform Init
        working-directory: infra
        run: |
          export ARM_SUBSCRIPTION_ID=${{ secrets.ARM_SUBSCRIPTION_ID }}
          terraform init \
            -backend-config="resource_group_name=${{ vars.TF_BACKEND_RG }}" \
            -backend-config="storage_account_name=${{ vars.TF_BACKEND_STORAGE }}" \
            -backend-config="container_name=${{ vars.TF_BACKEND_CONTAINER }}" \
            -backend-config="key=prod.terraform.tfstate"

      - name: üöÄ Terraform Apply
        working-directory: infra
        run: |
          export ARM_SUBSCRIPTION_ID=${{ secrets.ARM_SUBSCRIPTION_ID }}
          terraform apply -auto-approve

      - name: üì§ Capturar Outputs
        id: output_vm
        working-directory: infra
        run: |
          echo "vm_name=vm-automation" >> $GITHUB_OUTPUT
          echo "admin_username=azureuser" >> $GITHUB_OUTPUT
          echo "public_ip=$(terraform output -raw public_ip_address)" >> $GITHUB_OUTPUT
          echo "nsg_name=$(terraform output -raw nsg_name)" >> $GITHUB_OUTPUT
          echo "resource_group=$(terraform output -raw resource_group_name)" >> $GITHUB_OUTPUT

      - name: üîß Instalar Ansible e sshpass
        run: |
          sudo apt-get update
          sudo apt-get install -y ansible sshpass

      - name: üìù Criar Invent√°rio Ansible
        run: |
          echo "[vm]" > inventory
          echo "${{ steps.output_vm.outputs.public_ip }} ansible_user=azureuser ansible_password=${{ secrets.ADMIN_PASSWORD }} ansible_ssh_common_args='-o StrictHostKeyChecking=no'" >> inventory

      - name: üìò Executar Playbook Ansible
        run: |
          ansible-playbook -i inventory ansible/playbook.yml \
            --extra-vars "ansible_sudo_pass=${{ secrets.ADMIN_PASSWORD }}"

  # =========================================
  # JOB 3: POST-TESTS - Valida√ß√£o Final
  # =========================================
  post-tests:
    if: github.event.inputs.destroy == 'false'
    name: ‚úÖ P√≥s-Testes de Infra
    needs: deploy
    runs-on: ubuntu-latest
    env:
      PUBLIC_IP: ${{ needs.deploy.outputs.publicIP }}
      VM_NAME: ${{ needs.deploy.outputs.vmName }}
      NSG_NAME: ${{ needs.deploy.outputs.nsgName }}
      RESOURCE_GROUP: ${{ needs.deploy.outputs.resourceGroup }}

    steps:
      - name: üîê Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: üß™ Testar Swagger na Porta 8081
        run: |
          echo "Aguardando aplica√ß√£o subir com Swagger..."
          sleep 30
          response=$(curl -s -o /dev/null -w "%{http_code}" http://$PUBLIC_IP:8081/swagger-ui/index.html)
          if [ "$response" != "200" ]; then
            echo "‚ùå Swagger n√£o respondeu como esperado. Status HTTP: $response"
            exit 1
          else
            echo "‚úÖ Swagger dispon√≠vel em /swagger-ui/index.html na porta 8081!"
          fi

      - name: ‚úÖ Verificar status da VM
        run: |
          status=$(az vm get-instance-view \
            --name "$VM_NAME" \
            --resource-group "$RESOURCE_GROUP" \
            --query "instanceView.statuses[?code=='PowerState/running'].displayStatus" \
            --output tsv)

          echo "Status da VM: $status"
          if [ "$status" != "VM running" ]; then
              echo "‚ùå A VM n√£o est√° em execu√ß√£o!"
              exit 1
          else
              echo "‚úÖ VM est√° rodando com sucesso!"
          fi

      - name: ‚úÖ Verificar regra da NSG
        run: |
          result=$(az network nsg rule list \
            --nsg-name "$NSG_NAME" \
            --resource-group "$RESOURCE_GROUP" \
            --query "[?destinationPortRange=='8081' && access=='Allow']")

          if [ "$result" = "[]" ]; then
            echo "‚ùå Porta 8081 n√£o est√° liberada na NSG!"
            exit 1
          else
            echo "‚úÖ Porta 8081 est√° liberada corretamente na NSG!"
          fi

  # =========================================
  # JOB 4: DESTROY - Destrui√ß√£o controlada
  # =========================================
  destroy:
    if: github.event.inputs.destroy == 'true'
    name: üß® Destruir Infraestrutura
    runs-on: ubuntu-latest
    env:
      ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}

    steps:
      - name: üì• Checkout do c√≥digo
        uses: actions/checkout@v3

      - name: üîê Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: üîß Instalar Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.6.0'

      - name: üì¶ Terraform Init
        working-directory: infra
        run: |
          export ARM_SUBSCRIPTION_ID=${{ secrets.ARM_SUBSCRIPTION_ID }}
          terraform init \
            -backend-config="resource_group_name=${{ vars.TF_BACKEND_RG }}" \
            -backend-config="storage_account_name=${{ vars.TF_BACKEND_STORAGE }}" \
            -backend-config="container_name=${{ vars.TF_BACKEND_CONTAINER }}" \
            -backend-config="key=prod.terraform.tfstate"

      - name: üí• Terraform Destroy
        working-directory: infra
        run: terraform destroy -auto-approve