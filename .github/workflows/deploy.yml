name: ğŸš€ Deploy Azure VM + Docker Pipeline

on:
  push:
    branches:
      - main
    paths:
      - 'infra/**'
      - 'ansible/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:
    inputs:
      destroy:
        description: 'ğŸ§¨ DESTRUIR toda infraestrutura?'
        required: true
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

permissions:
  id-token: write
  contents: read

jobs:
  terraform-validate:
    if: github.event.inputs.destroy != 'true'
    name: ğŸ” Validar Terraform
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout do cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ” Login no Azure (OIDC)
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ğŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.6.0'

      - name: ğŸ“¦ Terraform Init
        working-directory: ./infra
        run: |
          terraform init \
            -backend-config="resource_group_name=${{ vars.TF_BACKEND_RG }}" \
            -backend-config="storage_account_name=${{ vars.TF_BACKEND_STORAGE }}" \
            -backend-config="container_name=${{ vars.TF_BACKEND_CONTAINER }}" \
            -backend-config="key=prod.terraform.tfstate"

      - name: âœ… Terraform Validate
        working-directory: ./infra
        run: terraform validate -no-color

      - name: ğŸ“‹ Terraform Plan
        working-directory: ./infra
        run: |
          terraform plan \
            -var="resource_group_name=${{ vars.AZURE_RG }}" \
            -var="location=${{ vars.AZURE_LOCATION }}" \
            -var="admin_password=${{ secrets.ADMIN_PASSWORD }}" \
            -out=tfplan \
            -input=false \
            -no-color

  terraform-deploy:
    if: github.event.inputs.destroy != 'true'
    name: ğŸš€ Deploy Infra
    needs: terraform-validate
    runs-on: ubuntu-latest
    outputs:
      vm_ip: ${{ steps.outputs.outputs.public_ip }}
      resource_group: ${{ steps.outputs.outputs.resource_group }}
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ” Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ğŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.6.0'

      - name: ğŸ“¦ Init
        working-directory: ./infra
        run: |
          terraform init \
            -backend-config="resource_group_name=${{ vars.TF_BACKEND_RG }}" \
            -backend-config="storage_account_name=${{ vars.TF_BACKEND_STORAGE }}" \
            -backend-config="container_name=${{ vars.TF_BACKEND_CONTAINER }}" \
            -backend-config="key=prod.terraform.tfstate"

      - name: ğŸš€ Terraform Apply
        working-directory: ./infra
        run: terraform apply -auto-approve

      - name: ğŸ“¤ Extrair Outputs
        id: outputs
        working-directory: ./infra
        run: |
          echo "public_ip=$(terraform output -raw public_ip_address)" >> $GITHUB_OUTPUT
          echo "resource_group=$(terraform output -raw resource_group_name)" >> $GITHUB_OUTPUT

  ansible-configure:
    if: github.event.inputs.destroy != 'true'
    name: âš™ï¸ Configurar VM
    needs: terraform-deploy
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ”§ Instalar Ansible + sshpass
        run: |
          sudo apt-get update
          sudo apt-get install -y ansible sshpass

      - name: ğŸ“ Criar InventÃ¡rio DinÃ¢mico
        run: |
          cat > inventory.ini <<EOF
          [vm]
          ${{ needs.terraform-deploy.outputs.vm_ip }} ansible_user=azureuser ansible_password=${{ secrets.ADMIN_PASSWORD }} ansible_ssh_common_args='-o StrictHostKeyChecking=no'
          EOF

      - name: ğŸ“˜ Executar Playbook
        run: |
          ansible-playbook -i inventory.ini ansible/playbook.yml \
            --extra-vars "ansible_sudo_pass=${{ secrets.ADMIN_PASSWORD }}" \
            -v

  smoke-tests:
    if: github.event.inputs.destroy != 'false'
    name: âœ… PÃ³s-Testes
    needs: ansible-configure
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ” Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ğŸ§ª Testar Swagger
        run: |
          IP="${{ needs.terraform-deploy.outputs.vm_ip }}"
          for i in {1..10}; do
            if curl -f -s http://${IP}:8081/swagger-ui/index.html > /dev/null; then
              echo "âœ… Swagger OK!"
              exit 0
            fi
            echo "Tentativa $i/10... aguardando 10s"
            sleep 10
          done
          echo "âŒ Swagger nÃ£o respondeu"
          exit 1

  terraform-destroy:
    if: github.event.inputs.destroy == 'true'
    name: ğŸ§¨ Destruir Infra
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ” Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ğŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.6.0'

      - name: ğŸ“¦ Init
        working-directory: ./infra
        run: |
          terraform init \
            -backend-config="resource_group_name=${{ vars.TF_BACKEND_RG }}" \
            -backend-config="storage_account_name=${{ vars.TF_BACKEND_STORAGE }}" \
            -backend-config="container_name=${{ vars.TF_BACKEND_CONTAINER }}" \
            -backend-config="key=prod.terraform.tfstate"

      - name: ğŸ’¥ Terraform Destroy
        working-directory: ./infra
        run: terraform destroy -auto-approve
